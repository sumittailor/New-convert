<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Protection Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; }
        .upload-area { 
            border: 2px dashed #2c7be5; 
            border-radius: 12px;
            padding: 40px; 
            text-align: center; 
            margin: 20px 0; 
            background-color: #f9fbfd;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover {
            background-color: #e3ebf6;
            border-color: #1a5bb8;
        }
        .password-section { 
            margin: 20px 0; 
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input[type="password"] { 
            padding: 12px; 
            margin: 5px; 
            width: 250px; 
            border: 1px solid #e3ebf6;
            border-radius: 6px;
            font-size: 16px;
        }
        input[type="password"]:focus {
            outline: none;
            border-color: #2c7be5;
            box-shadow: 0 0 0 3px rgba(44, 123, 229, 0.1);
        }
        button { 
            padding: 12px 24px; 
            background: #2c7be5; 
            color: white; 
            border: none; 
            border-radius: 6px;
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        button:hover {
            background: #1a5bb8;
        }
        button:disabled { 
            background: #6e84a3; 
            cursor: not-allowed;
        }
        .file-info { 
            margin: 15px 0; 
            padding: 12px;
            background: #e7f3ff;
            border-radius: 6px;
            border-left: 4px solid #2c7be5;
        }
        .download-link { 
            display: none; 
            margin-top: 20px; 
            padding: 15px;
            background: #00d97e; 
            color: white;
            border-radius: 6px;
            text-align: center;
        }
        .download-link a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
        }
        .download-link a:hover {
            text-decoration: underline;
        }
        .error-message {
            color: #e74c3c;
            background: #fde8e8;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        .success-message {
            color: #00d97e;
            background: #e8fdf1;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        h1 { color: #2c3e50; text-align: center; }
        h3 { color: #2c3e50; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF Protection Tool</h1>
        
        <div class="upload-area" id="uploadArea">
            <p><strong>Drag & drop your PDF file here or click to browse</strong></p>
            <input type="file" id="fileInput" accept=".pdf" style="display: none;">
            <button onclick="document.getElementById('fileInput').click()">Browse Files</button>
        </div>

        <div class="file-info" id="fileInfo" style="display: none;"></div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="password-section" id="passwordSection" style="display: none;">
            <h3>Set Password</h3>
            <div>
                <input type="password" id="password" placeholder="Enter password">
                <input type="password" id="confirmPassword" placeholder="Confirm password">
                <button id="protectBtn" onclick="protectPDF()">Protect PDF</button>
            </div>
            <p style="font-size: 14px; color: #6e84a3; margin-top: 10px;">
                Password must be at least 4 characters long
            </p>
        </div>

        <div class="download-link" id="downloadLink">
            <a id="downloadAnchor" download="protected.pdf">Download Protected File</a>
        </div>
    </div>

    <script>
        let currentFile = null;

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        // Drag and drop handling
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#e3ebf6';
            uploadArea.style.borderColor = '#1a5bb8';
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f9fbfd';
            uploadArea.style.borderColor = '#2c7be5';
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f9fbfd';
            uploadArea.style.borderColor = '#2c7be5';
            if (e.dataTransfer.files.length > 0) {
                handleFileSelect(e.dataTransfer.files[0]);
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function handleFileSelect(file) {
            hideMessages();
            
            if (file.type !== 'application/pdf') {
                showError('Please upload a PDF file');
                return;
            }

            // Check file size (max 50MB)
            if (file.size > 50 * 1024 * 1024) {
                showError('File is too large. Maximum size is 50MB.');
                return;
            }

            currentFile = file;
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `Selected file: <strong>${file.name}</strong> (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            fileInfo.style.display = 'block';
            
            // Show password section
            document.getElementById('passwordSection').style.display = 'block';
            
            // Enable protect button when passwords match
            document.getElementById('password').addEventListener('input', validatePasswords);
            document.getElementById('confirmPassword').addEventListener('input', validatePasswords);
            
            showSuccess('PDF file selected successfully. Now set a password.');
        }

        function validatePasswords() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const protectBtn = document.getElementById('protectBtn');
            
            if (password && password === confirmPassword && currentFile) {
                protectBtn.disabled = false;
                if (password.length < 4) {
                    showError('Password must be at least 4 characters long');
                    protectBtn.disabled = true;
                } else {
                    hideMessages();
                }
            } else {
                protectBtn.disabled = true;
                if (password !== confirmPassword && confirmPassword) {
                    showError('Passwords do not match');
                } else {
                    hideMessages();
                }
            }
        }

        // FIXED: Clean file name to prevent multiple "_protected" suffixes
        function getProtectedFileName(file, extension = 'zip') {
            let baseName = file.name;
            
            // Remove the file extension
            baseName = baseName.replace(/\.pdf$/i, '');
            
            // Remove any existing "_protected" suffixes (and any numbers after them)
            baseName = baseName.replace(/_protected(?:_\d+)?$/i, '');
            
            // Add timestamp to make filename unique
            const timestamp = new Date().getTime();
            
            // Return clean protected filename
            return `${baseName}_protected_${timestamp}.${extension}`;
        }

        async function protectPDF() {
            if (!currentFile) {
                showError('Please select a PDF file first');
                return;
            }

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            if (password.length < 4) {
                showError('Password must be at least 4 characters long');
                return;
            }

            const protectBtn = document.getElementById('protectBtn');
            protectBtn.disabled = true;
            protectBtn.textContent = 'Protecting PDF...';

            try {
                // Method 1: Password-protected ZIP (Recommended for client-side)
                await createPasswordProtectedZip(currentFile, password);
                
                showSuccess('PDF protected successfully! Click the download link below.');
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error protecting PDF: ' + error.message);
            } finally {
                protectBtn.textContent = 'Protect PDF';
                protectBtn.disabled = false;
            }
        }

        // Method 1: Create password-protected ZIP
        async function createPasswordProtectedZip(file, password) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const zip = new JSZip();
                        
                        // Add PDF to zip with password protection
                        zip.file('document.pdf', e.target.result, {
                            compression: "DEFLATE",
                            compressionOptions: { level: 6 }
                        });
                        
                        // Generate the zip file with password protection
                        const zipContent = await zip.generateAsync({
                            type: "blob",
                            compression: "DEFLATE",
                            compressionOptions: { level: 6 },
                            encrypt: true,
                            password: password
                        });
                        
                        // Create download link
                        const downloadLink = document.getElementById('downloadLink');
                        const downloadAnchor = document.getElementById('downloadAnchor');
                        
                        // FIXED: Use the clean filename function
                        const protectedFileName = getProtectedFileName(file, 'zip');
                        downloadAnchor.download = protectedFileName;
                        downloadAnchor.href = URL.createObjectURL(zipContent);
                        
                        downloadLink.style.display = 'block';
                        downloadAnchor.textContent = `Download ${protectedFileName}`;
                        
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Method 2: Using pdf-lib (Alternative method)
        async function protectWithPdfLib(file, password) {
            // Load pdf-lib dynamically
            const { PDFDocument } = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js');
            
            const arrayBuffer = await file.arrayBuffer();
            const pdfDoc = await PDFDocument.load(arrayBuffer);
            
            // Set up encryption
            pdfDoc.encrypt({
                userPassword: password,
                ownerPassword: password,
                permissions: {
                    printing: 'lowResolution',
                    modifying: false,
                    copying: false,
                    annotating: false,
                    fillingForms: false,
                    contentAccessibility: false,
                    documentAssembly: false
                }
            });
            
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            
            const downloadLink = document.getElementById('downloadLink');
            const downloadAnchor = document.getElementById('downloadAnchor');
            
            // FIXED: Use the clean filename function
            const protectedFileName = getProtectedFileName(file, 'pdf');
            downloadAnchor.download = protectedFileName;
            downloadAnchor.href = URL.createObjectURL(blob);
            
            downloadLink.style.display = 'block';
            downloadAnchor.textContent = `Download ${protectedFileName}`;
        }
    </script>
</body>
</html>
